<html>
<head>
	<title></title>
	<link rel="stylesheet" type="text/css" href="main.css"></link>
</head>
<body>
	<div class="qipan">
		<ul id="qizi_area">
		</ul>
	</div>
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/jquery.soul.js"></script>
	<script type="text/javascript" src="js/jquery.coord.js"></script>
	<script type="text/javascript">
	var Actor = $.soul.instance('actor');
	var crowd = {
		"0":{"role":"r","career":"che","coord":{"x":1,"y":1},"index":0},
		"1":{"role":"r","career":"ma","coord":{"x":2,"y":1},"index":1},
		"2":{"role":"r","career":"xiang","coord":{"x":3,"y":1},"index":2},
		"3":{"role":"r","career":"shi","coord":{"x":4,"y":1},"index":3},
		"4":{"role":"r","career":"shuai","coord":{"x":5,"y":1},"index":4},
		"5":{"role":"r","career":"shi","coord":{"x":6,"y":1},"index":5},
		"6":{"role":"r","career":"xiang","coord":{"x":7,"y":1},"index":6},
		"7":{"role":"r","career":"ma","coord":{"x":8,"y":1},"index":7},
		"8":{"role":"r","career":"che","coord":{"x":9,"y":1},"index":8},
		"19":{"role":"r","career":"pao","coord":{"x":2,"y":3},"index":19},
		"25":{"role":"r","career":"pao","coord":{"x":8,"y":3},"index":25},
		"27":{"role":"r","career":"zu","coord":{"x":1,"y":4},"index":27},
		"29":{"role":"r","career":"zu","coord":{"x":3,"y":4},"index":29},
		"31":{"role":"r","career":"zu","coord":{"x":5,"y":4},"index":31},
		"33":{"role":"r","career":"zu","coord":{"x":7,"y":4},"index":33},
		"35":{"role":"r","career":"zu","coord":{"x":9,"y":4},"index":35},
		"54":{"role":"b","career":"zu","coord":{"x":1,"y":7},"index":54},
		"56":{"role":"b","career":"zu","coord":{"x":3,"y":7},"index":56},
		"58":{"role":"b","career":"zu","coord":{"x":5,"y":7},"index":58},
		"60":{"role":"b","career":"zu","coord":{"x":7,"y":7},"index":60},
		"62":{"role":"b","career":"zu","coord":{"x":9,"y":7},"index":62},
		"64":{"role":"b","career":"pao","coord":{"x":2,"y":8},"index":64},
		"70":{"role":"b","career":"pao","coord":{"x":8,"y":8},"index":70},
		"81":{"role":"b","career":"che","coord":{"x":1,"y":10},"index":81},
		"82":{"role":"b","career":"ma","coord":{"x":2,"y":10},"index":82},
		"83":{"role":"b","career":"xiang","coord":{"x":3,"y":10},"index":83},
		"84":{"role":"b","career":"shi","coord":{"x":4,"y":10},"index":84},
		"85":{"role":"b","career":"shuai","coord":{"x":5,"y":10},"index":85},
		"86":{"role":"b","career":"shi","coord":{"x":6,"y":10},"index":86},
		"87":{"role":"b","career":"xiang","coord":{"x":7,"y":10},"index":87},
		"88":{"role":"b","career":"ma","coord":{"x":8,"y":10},"index":88},
		"89":{"role":"b","career":"che","coord":{"x":9,"y":10},"index":89}
	};
	Actor.fill(crowd);

	coordManager = $.coord.instance({
        box: $('#qizi_area'),
		row:9,
        col:10,
        width:104,
        height:100,
        offset:0,//-40
        onClick:onCoordClick
    });
    coordManager.cube.run(function(item, index){
    	if(item.index > 35){
    		item.data.belong = 'b';
    	}else{
    		item.data.belong = 'r';
    	}
    });

    Actor.run(function(pawn, index){
        var pawnCoord = coordManager.getItemByIndex(pawn.index);
    	var el = $('<li>');
        el.attr({
            'class':'item empty',// + pawn.role+'-'+pawn.career,
            'index':pawn.index
        }).css({
            'top':pawnCoord.top,
            'left':pawnCoord.left
        });
        el.html(pawn.index);
        pawn.el = el;
        pawnCoord.data.pawn = pawn;
        coordManager.box.append(el);
    });
    
    function move(startPawn, endPawn){
        var s_cn = endPawn.role ? endPawn.role+'-'+endPawn.career : 'empty';
        endPawn.el.classList.remove(s_cn);

        var c_cn = startPawn.role+'-'+startPawn.career;
        endPawn.el.classList.add(c_cn);
        endPawn.role = startPawn.role;
        endPawn.career = startPawn.career;              

        startPawn.el.classList.remove(c_cn);
        startPawn.el.classList.add('empty');
        startPawn.role = null;
        startPawn.career = null;
    }

	function hover(el, is_hover){
        is_hover ? el.addClass('hover') : el.removeClass('hover');
    }

	function rangeHover(range){
		range.forEach(function(index){
			var coord = coordManager.getPosByIndex(index);
			isOn ? hover(coord.el, true) : hover(coord.el, false);
		})
	}
	var game = {
		round: 0,
		actor:{
			role: 'r',
			status: 0,
			pawn:null,
			range:null
		},
		status: 'doing'
	};

	function onCoordClick(coord){
		var pawn = coord.data.pawn;
		var actor = game.actor;

		if(game.status != 'doing'){
			return false;
		}
		if(actor.role != pawn.role){
			return false;
		}

		if(actor.status == 0){
			actor.status = 1;
			actor.pawn = pawn;
			actor.range = getCareerRange(coord);
			hover(pawn.el, true);
			rangeHover(actor.range, true);
		}else{
			var is_range = $.inArray(actor.range, pawn.index) != -1;
			if(is_range){
				move(actor.pawn, pawn);
				actor.role = actor.role == 'r' ? 'b' : 'r';
			}
			hover(actor.pawn, false);
			rangeHover(actor.range, false);
			actor.status = 0;
			actor.pawn = null;
			actor.range = null;
		}
	}


	// function pao_RangeFilter(type, o_range, c_index, c_role){
	// 	var range = [];
	// 	o_range.every(function(i_pos){
	// 		var index = i_pos.index;
	// 		var role = i_pos.role;
	// 		if(index == c_index){
	// 			range.push(aim.getIndex());
	// 			aim.clear();
	// 		}else if(index > c_index){
	// 			if(role){
	// 				range = [];
	// 				aim.setBigAim(i_pos);
	// 			}else{
	// 				if(!aim.hasLean() || aim.mensLean(type, i_pos)){
	// 					range.push(index);
	// 				}
	// 			}
	// 		}else{
	// 			if(role){
	// 				aim.setSmallAim(i_pos);
	// 				if(aim.getIndex() != -1){
	// 					return false;
	// 				}
	// 			}else{
	// 				if(!aim.hasLean()){
	// 					range.push(index);
	// 				}
	// 			}
	// 		}
	// 		return true;
	// 	});
	// 	return range;
	// }

	// function che_RangeFilter(o_range, c_index, c_role){
	// 	var range = [];
	// 	o_range.every(function(pos){
	// 		var index = pos.index;
	// 		var role = pos.role;
	// 		if(index > c_index){
	// 			if(role){
	// 				range = [];
	// 			}
	// 			range.push(index);
	// 		}else{
	// 			range.push(index);
	// 			if(role && index != c_index){
	// 				return false;
	// 			}
	// 		}
	// 		return true;
	// 	})
	// 	return range;
	// }

	// function getHVRange(type, len, origin_num){
	// 	var range = [];
	// 	for(var i=len;i>0;i--){
	// 		var index = type == 'v' ? 
	// 					map.getIndexByXY(origin_num, i) : 
	// 					map.getIndexByXY(i,origin_num);
	// 		var pos = map.getPosByIndex(index);
	// 		pos && range.push(pos);
	// 	}
	// 	return range;	
	// }
	// function qizi_rangeFilter(pos, o_range, filter){
	// 	var range = [];
	// 	o_range.forEach(function(index, i){
	// 		var i_pos = map.getPosByIndex(index);
	// 		if(i_pos && pos.role != i_pos.role){
	// 			if(!filter || (filter.indexOf(index)!=-1)){
	// 				range.push(index);
	// 			}
	// 		}
	// 	});
	// 	return range;
	// }

	var Limiter = $.soul.instance('limiter');

	Limiter.create('filter', function(coord, range) {
	    var career = coord.data.pawn.career;
	    var filetr = Limiter.get(career);

	    range = filetr(range);
	    
	    return range;
	});

	Limiter.create('white', function(range, filter) {
	    var ret = [];
	    $.each(range, function(i, index) {
	        $.inArray(filter, index) != -1 && ret.push(index);
	    })
	    return ret;
	});

	Limiter.create('house', function(range, role) {
	    var ret = [];
	    var filter = role == 'r' ? [3, 4, 5, 12, 13, 14, 21, 22, 23] : [66, 67, 68, 75, 76, 77, 84, 85, 86];
	    Limiter.white(range, filter);
	    return ret;
	});

	Limiter.create('wall', function(range, role) {
	    var ret = [];
	    var filter = role == 'r' ? [2, 6, 18, 22, 26, 38, 44] : [47, 51, 63, 67, 71, 83, 87];
	    Limiter.white(range, filter);
	    return ret;
	});

	Limiter.in('shuai', function(coord, range){
		var role = coord.data.pawn.role;
	    return Limiter.house(range, role);
	});

	Limiter.in('shi', function(coord, range){
		var role = coord.data.pawn.role;
	    return Limiter.house(range, role);
	});

	Limiter.in('xiang', function(coord, range){
		var role = coord.data.pawn.role;
	    var pawn = coord.data.pawn;
	    var x = pawn.x;
	    var y = pawn.y;
	    var pindex = pawn.index;
	    
	    var range = Limiter.wall(range, role);
	    var ret = [];

	    $.each(range, function(i, item){
	        var min = Math.min(pindex, item);
	        var max = Math.max(pindex, item);
	        var index = min + (max - min)/2;
	        if(coordManager.isEmptyPos(index))}{
	            ret.push(item);
	        }
	    });

	    return ret;
	});

	function getCareerRange(coord){
		var ret = [];
		var range = Career.getActRange(coord);
		var indexRange = [];
		$.each(range, function(i, item){
			var index = coord.getIndexByCoord(item[0], item[1]);
			indexRange[i] = index;
		});
		range = Limiter.filter(coord, indexRange);

		// function pushRange(items, check){
		// 	if(check){
		// 		if(map.isEmptyPos(check[0],check[1])){
		// 			items.forEach(function(item){
		// 				range.push(map.getIndexByXY(item[0],item[1]));
		// 			})
		// 		}
		// 	}else{
		// 		range.push(map.getIndexByXY(items[0],items[1]));
		// 	}
			
		// }

		console.log(range);
		return;




        // filter = map.getWall(c_role);
        // break;

		// ret = qizi_rangeFilter(coord, range, filter);
		// return ret;

		switch(c_pos.career){
			case 'pao':
				var x_range = getHVRange('h', 9, c_y);
				var y_range = getHVRange('v', 10, c_x);
				x_range = pao_RangeFilter('h', x_range, c_index, c_role);
				x_range.push(aim.getIndex());
				aim.clear();
				y_range = pao_RangeFilter('v', y_range, c_index, c_role);
				y_range.push(aim.getIndex());
				aim.clear();
				range = x_range.concat(y_range);
				break;
			case 'che':
				var x_range = getHVRange('h', 9, c_y);
				var y_range = getHVRange('v', 10, c_x);
				x_range = che_RangeFilter(x_range, c_index, c_role);
				y_range = che_RangeFilter(y_range, c_index, c_role);
				range = x_range.concat(y_range);
				break;
			case 'ma':
				pushRange([[c_x-1,c_y-2],[c_x+1,c_y-2]],[c_x,c_y-1]);
				pushRange([[c_x+2,c_y-1],[c_x+2,c_y+1]],[c_x+1,c_y]);
				pushRange([[c_x-1,c_y+2],[c_x+1,c_y+2]],[c_x,c_y+1]);
				pushRange([[c_x-2,c_y-1],[c_x-2,c_y+1]],[c_x-1,c_y]);
				break;



		}
	}

	// var aim = (function(){
	// 	var aim_pos = null;
	// 	var lean_pos = null;
	// 	function getIndex(c_role){
	// 		if(lean_pos && aim_pos){
	// 			if(c_role != aim_pos.role){
	// 				return aim_pos.index;
	// 			}
	// 		}
	// 		return -1;
	// 	}
	// 	function setSmallAim(pos){
	// 		if(lean_pos){
	// 			aim_pos = pos;
	// 		}else{			
	// 			lean_pos = pos;
	// 		}
	// 	}
	// 	function setBigAim(pos){
	// 		if(lean_pos){
	// 			aim_pos = lean_pos;
	// 			lean_pos = pos;
	// 		}else if(aim_pos){
	// 			lean_pos = pos;
	// 		}else{
	// 			aim_pos = pos;
	// 		}
	// 	}
	// 	function mensLean(type, pos){
	// 		if(type == 'h' ? pos.x < lean_pos.x : pos.y < lean_pos.y){
	// 			return true;
	// 		}
	// 		return false;
	// 	}
	// 	function hasLean(){
	// 		return lean_pos ? true : false;
	// 	}
	// 	function clear(){
	// 		aim_pos = null;
	// 		lean_pos = null;
	// 	}
	// 	return {
	// 		mensLean:mensLean,
	// 		hasLean:hasLean,
	// 		setSmallAim:setSmallAim,
	// 		setBigAim:setBigAim,
	// 		getIndex:getIndex,
	// 		clear:clear
	// 	};
	// })();
	</script>
</body>
</html>