<html>
<head>
	<title></title>
	<link rel="stylesheet" type="text/css" href="main.css"></link>
</head>
<body>
	<div class="qipan">
		<ul id="qizi_area">
		</ul>
	</div>
	<script type="text/javascript" src="js/jquery.min.js"></script>
	<script type="text/javascript" src="js/jquery.soul.js"></script>
	<script type="text/javascript" src="js/jquery.coord.js"></script>
	<script type="text/javascript" src="js/jquery.career.js"></script>
	<script type="text/javascript">
	var Actor = $.soul.instance('actor');
	var crowd = {
		"0":{"role":"r","career":"che","x":1,"y":1,"index":0},
		"1":{"role":"r","career":"ma","x":2,"y":1,"index":1},
		"2":{"role":"r","career":"xiang","x":3,"y":1,"index":2},
		"3":{"role":"r","career":"shi","x":4,"y":1,"index":3},
		"4":{"role":"r","career":"shuai","x":5,"y":1,"index":4},
		"5":{"role":"r","career":"shi","x":6,"y":1,"index":5},
		"6":{"role":"r","career":"xiang","x":7,"y":1,"index":6},
		"7":{"role":"r","career":"ma","x":8,"y":1,"index":7},
		"8":{"role":"r","career":"che","x":9,"y":1,"index":8},
		"19":{"role":"r","career":"pao","x":2,"y":3,"index":19},
		"25":{"role":"r","career":"pao","x":8,"y":3,"index":25},
		"27":{"role":"r","career":"zu","x":1,"y":4,"index":27},
		"29":{"role":"r","career":"zu","x":3,"y":4,"index":29},
		"31":{"role":"r","career":"zu","x":5,"y":4,"index":31},
		"33":{"role":"r","career":"zu","x":7,"y":4,"index":33},
		"35":{"role":"r","career":"zu","x":9,"y":4,"index":35},
		"54":{"role":"b","career":"zu","x":1,"y":7,"index":54},
		"56":{"role":"b","career":"zu","x":3,"y":7,"index":56},
		"58":{"role":"b","career":"zu","x":5,"y":7,"index":58},
		"60":{"role":"b","career":"zu","x":7,"y":7,"index":60},
		"62":{"role":"b","career":"zu","x":9,"y":7,"index":62},
		"64":{"role":"b","career":"pao","x":2,"y":8,"index":64},
		"70":{"role":"b","career":"pao","x":8,"y":8,"index":70},
		"81":{"role":"b","career":"che","x":1,"y":10,"index":81},
		"82":{"role":"b","career":"ma","x":2,"y":10,"index":82},
		"83":{"role":"b","career":"xiang","x":3,"y":10,"index":83},
		"84":{"role":"b","career":"shi","x":4,"y":10,"index":84},
		"85":{"role":"b","career":"shuai","x":5,"y":10,"index":85},
		"86":{"role":"b","career":"shi","x":6,"y":10,"index":86},
		"87":{"role":"b","career":"xiang","x":7,"y":10,"index":87},
		"88":{"role":"b","career":"ma","x":8,"y":10,"index":88},
		"89":{"role":"b","career":"che","x":9,"y":10,"index":89}
	};
	Actor.fill(crowd);

	coordManager = $.coord.instance({
        box: $('#qizi_area'),
		row:9,
        col:10,
        width:104,
        height:100,
        offset:0,//-40
        onClick:onCoordClick
    });
    coordManager.cube.run(function(item, index){
    	if(item.index > 35){
    		item.data.belong = 'b';
    	}else{
    		item.data.belong = 'r';
    	}
    	var el = $('<li>');
        el.attr({
            'class':'item empty',// + pawn.role+'-'+pawn.career,
            'index':item.index
        }).css({
            'top':item.top,
            'left':item.left
        });
        item.data.el = el;
        coordManager.box.append(el);
    });

    Actor.run(function(pawn, index){
        var coord = coordManager.getItemByIndex(pawn.index);
        coord.data.el.attr('class', 'item ' + pawn.role+'-'+pawn.career);
        coord.data.pawn = pawn;
        coord.data.isEmpty = true; 
    });
    
    function move(startCoord, endCoord){
        var s_cn = endPawn.role ? endPawn.role+'-'+endPawn.career : 'empty';
        endPawn.el.classList.remove(s_cn);

        var c_cn = startPawn.role+'-'+startPawn.career;
        endPawn.el.classList.add(c_cn);
        endPawn.role = startPawn.role;
        endPawn.career = startPawn.career;              

        startPawn.el.classList.remove(c_cn);
        startPawn.el.classList.add('empty');
        startPawn.role = null;
        startPawn.career = null;
    }

	function hover(el, is_hover){
        is_hover ? el.addClass('hover') : el.removeClass('hover');
    }

	function rangeHover(range, isOn){
		range.forEach(function(index){
			var coord = coordManager.getItemByIndex(index);
			isOn ? hover(coord.data.el, true) : hover(coord.data.el, false);
		})
	}
	var game = {
		round: 0,
		actor:{
			role: 'r',
			status: 0,
			coord:null,
			pawn:null,
			range:null
		},
		status: 'doing'
	};

	function onCoordClick(coord){
		var pawn = coord.data.pawn;
		var actor = game.actor;

		if(game.status != 'doing'){
			return false;
		}
		if(actor.role != pawn.role){
			return false;
		}

		if(actor.status == 0){
			actor.status = 1;
			actor.coord = coord;
			actor.pawn = pawn;
			actor.range = getCareerRange(coord);
			// hover(pawn.el, true);
			rangeHover(actor.range, true);
		}else{
			var is_range = $.inArray(actor.range, pawn.index) != -1;
			if(is_range){
				move(actor.pawn, pawn);
				actor.role = actor.role == 'r' ? 'b' : 'r';
				actor.coord.data.isEmpty = true; 
				coord.data.isEmpty = false;
			}
			// hover(actor.pawn, false);
			rangeHover(actor.range, false);
			actor.status = 0;
			actor.coord = null;
			actor.pawn = null;
			actor.range = null;
		}
	}

	function getCareerRange(coord){
		var ret = [];
		var range = Career.getActRange(coord, coordManager);
		console.log(range);
		return range;




        // filter = map.getWall(c_role);
        // break;

		// ret = qizi_rangeFilter(coord, range, filter);
		// return ret;

		// switch(c_pos.career){
		// 	case 'pao':
		// 		var x_range = getHVRange('h', 9, c_y);
		// 		var y_range = getHVRange('v', 10, c_x);
		// 		x_range = pao_RangeFilter('h', x_range, c_index, c_role);
		// 		x_range.push(aim.getIndex());
		// 		aim.clear();
		// 		y_range = pao_RangeFilter('v', y_range, c_index, c_role);
		// 		y_range.push(aim.getIndex());
		// 		aim.clear();
		// 		range = x_range.concat(y_range);
		// 		break;
		// }
	}

	</script>
</body>
</html>